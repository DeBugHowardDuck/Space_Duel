<div id="fight-panel"
     class="card"
     hx-headers='{"X-CSRF-Token":"{{ csrf_token }}"}' xmlns:hx-on="http://www.w3.org/1999/xhtml">

  {% set p = arena.player %}
  {% set e = arena.ai %}
    {% set cd_over = arena.cooldowns['player']['overcharge']|int %}
  {% set cd_emp  = arena.cooldowns['player']['emp']|int %}



<div class="panel-head">
  <h2 class="title">Space Duel</h2>
  <span class="chip {{ 'chip-you' if arena.turn == 'player' else 'chip-ai' }}">
    {{ '–í–∞—à —Ö–æ–¥' if arena.turn == 'player' else '–•–æ–¥ –ò–ò' }}
  </span>
</div>
    {% if arena.is_finished %}
  {% set outcome = 'draw' %}
  {% if arena.player.is_alive and not arena.ai.is_alive %}{% set outcome = 'win' %}
  {% elif arena.ai.is_alive and not arena.player.is_alive %}{% set outcome = 'lose' %}
  {% endif %}
  <div class="banner banner-{{ outcome }}">
    {{ '–ü–æ–±–µ–¥–∞ üéâ' if outcome == 'win' else ('–ü–æ—Ä–∞–∂–µ–Ω–∏–µ ‚ò†Ô∏è' if outcome == 'lose' else '–ù–∏—á—å—è') }}
  </div>
{% endif %}
  <div class="row">
    <div>
      <h2 class="title">–ò–≥—Ä–æ–∫: {{ p.name }}</h2>
      <div class="muted">–ö–ª–∞—Å—Å: {{ p.unit_class.name }}</div>
      <div class="muted">–û—Ä—É–∂–∏–µ: {{ p.weapon.name }}</div>
      <div class="muted">–©–∏—Ç: {{ p.shield.name }}</div>

      <div class="muted" style="margin-top:8px;">–ö–æ—Ä–ø—É—Å: {{ p.hull }}/{{ p.hull_max }}</div>
      <div class="meter">
        <i style="width: {{ (100 * p.hull / p.hull_max)|round(0, 'floor') }}%"></i>
      </div>

      <div class="muted" style="margin-top:8px;">
        –©–∏—Ç: {{ p.shield_hp }}/{{ p.shield.capacity }}
      </div>
      <div class="meter m2">
        {% set cap = p.shield.capacity %}
        {% set s_pct = 100 * (p.shield_hp if cap>0 else 0) / (cap if cap>0 else 1) %}
        <i style="width: {{ s_pct|round(0, 'floor') }}%"></i>
      </div>

      <div class="muted" style="margin-top:8px;">
        –≠–Ω–µ—Ä–≥–∏—è: {{ p.energy }}/{{ p.energy_max }}
      </div>
      <div class="meter">
        <i style="width: {{ (100 * p.energy / p.energy_max)|round(0, 'floor') }}%"></i>
      </div>
    </div>

    <div>
      <h2 class="title">–í—Ä–∞–≥: {{ e.name }}</h2>
      <div class="muted">–ö–ª–∞—Å—Å: {{ e.unit_class.name }}</div>
      <div class="muted">–û—Ä—É–∂–∏–µ: {{ e.weapon.name }}</div>
      <div class="muted">–©–∏—Ç: {{ e.shield.name }}</div>

      <div class="muted" style="margin-top:8px;">–ö–æ—Ä–ø—É—Å: {{ e.hull }}/{{ e.hull_max }}</div>
      <div class="meter">
        <i style="width: {{ (100 * e.hull / e.hull_max)|round(0, 'floor') }}%"></i>
      </div>

      <div class="muted" style="margin-top:8px;">
        –©–∏—Ç: {{ e.shield_hp }}/{{ e.shield.capacity }}
      </div>
      <div class="meter m2">
        {% set cap2 = e.shield.capacity %}
        {% set s2_pct = 100 * (e.shield_hp if cap2>0 else 0) / (cap2 if cap2>0 else 1) %}
        <i style="width: {{ s2_pct|round(0, 'floor') }}%"></i>
      </div>

      <div class="muted" style="margin-top:8px;">
        –≠–Ω–µ—Ä–≥–∏—è: {{ e.energy }}/{{ e.energy_max }}
      </div>
      <div class="meter">
        <i style="width: {{ (100 * e.energy / e.energy_max)|round(0, 'floor') }}%"></i>
      </div>
    </div>
  </div>

  <div style="margin-top:12px;">
    {% if arena.is_finished %}
      {% if p.is_alive and not e.is_alive %}
        <div class="win">–ü–æ–±–µ–¥–∞! üéâ</div>
      {% elif e.is_alive and not p.is_alive %}
        <div class="lose">–ü–æ—Ä–∞–∂–µ–Ω–∏–µ‚Ä¶ ‚ò†Ô∏è</div>
      {% else %}
        <div class="muted">–ë–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω.</div>
      {% endif %}
    {% else %}
      <div class="muted">–•–æ–¥: <span class="turn">{{ arena.turn }}</span></div>
    {% endif %}
  </div>

  <div class="stack" style="margin-top:12px;">
            {# –£–î–ê–† #}
        {% set can_hit = (not arena.is_finished and arena.turn == 'player' and arena.player.can_fire()) %}
        <button class="btn"
          hx-post="/fight/hit"
          hx-target="#fight-panel"
          hx-swap="outerHTML"
          hx-indicator="#loading"
          hx-on::before-request="this.disabled=true"
          hx-on::after-request="this.disabled=false"
          {% if not can_hit %}
            disabled
            title="{{ '–±–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω' if arena.is_finished else ('–Ω–µ –≤–∞—à —Ö–æ–¥' if arena.turn != 'player' else '–º–∞–ª–æ —ç–Ω–µ—Ä–≥–∏–∏') }}"
          {% else %}
            title="–í—ã—Å—Ç—Ä–µ–ª–∏—Ç—å"
          {% endif %}
        >
          –£–¥–∞—Ä
        </button>

        {# –ü–ê–°–° #}
        {% set can_pass = (not arena.is_finished and arena.turn == 'player') %}
        <button class="btn"
          hx-post="/fight/pass-turn"
          hx-target="#fight-panel"
          hx-swap="outerHTML"
          hx-indicator="#loading"
          hx-on::before-request="this.disabled=true"
          hx-on::after-request="this.disabled=false"
          {% if not can_pass %}disabled title="{{ '–±–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω' if arena.is_finished else '–Ω–µ –≤–∞—à —Ö–æ–¥' }}"{% else %}title="–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —ç–Ω–µ—Ä–≥–∏—é/—â–∏—Ç"{% endif %}
        >
          –ü–∞—Å—Å
        </button>

        {# Overcharge (20 —ç–Ω–µ—Ä–≥–∏–∏) #}
        {% set can_over = (not arena.is_finished and arena.turn == 'player' and p.energy >= 20 and cd_over <= 0) %}
        <button class="btn"
          hx-post="/fight/use-skill/overcharge"
          hx-target="#fight-panel"
          hx-swap="outerHTML"
          hx-indicator="#loading"
          hx-on::before-request="this.disabled=true"
          hx-on::after-request="this.disabled=false"
          {% if not can_over %}disabled{% endif %}
          title="{% if arena.is_finished %}–±–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω{% elif arena.turn!='player' %}–ù–µ –≤–∞—à —Ö–æ–¥{% elif p.energy<20 %}–ú–∞–ª–æ —ç–Ω–µ—Ä–≥–∏–∏{% elif cd_over>0 %}–ö–î: {{ cd_over }} —Ö–æ–¥–∞{% else %}–°–∫–∏–ª–ª: Overcharge{% endif %}"
        >
          –°–∫–∏–ª–ª: Overcharge
        </button>

        {# EMP (25 —ç–Ω–µ—Ä–≥–∏–∏) #}
        {% set can_emp = (not arena.is_finished and arena.turn == 'player' and p.energy >= 25 and cd_emp <= 0) %}
        <button class="btn"
          hx-post="/fight/use-skill/emp"
          hx-target="#fight-panel"
          hx-swap="outerHTML"
          hx-indicator="#loading"
          hx-on::before-request="this.disabled=true"
          hx-on::after-request="this.disabled=false"
          {% if not can_emp %}disabled{% endif %}
          title="{% if arena.is_finished %}–±–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω{% elif arena.turn!='player' %}–ù–µ –≤–∞—à —Ö–æ–¥{% elif p.energy<25 %}–ú–∞–ª–æ —ç–Ω–µ—Ä–≥–∏–∏{% elif cd_emp>0 %}–ö–î: {{ cd_emp }} —Ö–æ–¥–∞{% else %}–°–∫–∏–ª–ª: EMP{% endif %}"
        >
          –°–∫–∏–ª–ª: EMP
        </button>

        {# –°–ë–†–û–° #}
        <button class="btn"
          hx-post="/fight/end-fight"
          hx-target="#fight-panel"
          hx-swap="outerHTML"
          hx-indicator="#loading"
          hx-on::before-request="this.disabled=true"
          hx-on::after-request="this.disabled=false"
          title="–ù–∞—á–∞—Ç—å –Ω–æ–≤—É—é –±–∏—Ç–≤—É"
        >
          –ó–∞–≤–µ—Ä—à–∏—Ç—å –±–æ–π (—Å–±—Ä–æ—Å)
        </button>

    <span class="center muted">
      <span class="spinner" id="loading"></span>
      <span id="status"></span>
    </span>
  </div>

      <div style="margin-top:16px;">
        {% include "_stats_box.html" %}
      </div>

  <div style="margin-top:16px;">
    <div class="muted" style="margin-bottom:6px;">–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è</div>
        <div class="log">
          {% set vis = arena.ui_log %}
          {% for line in vis[-8:] %}
            <div>‚Äî {{ line }}</div>
          {% else %}
            <div class="muted">–ü–æ–∫–∞ –ø—É—Å—Ç–æ‚Ä¶</div>
          {% endfor %}
        </div>
  </div>
</div>
